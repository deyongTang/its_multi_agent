<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ITS å¤šæ™ºèƒ½ä½“ â€” å…¨é“¾è·¯æµ‹è¯•</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, 'PingFang SC', sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
h1 { text-align: center; margin-bottom: 8px; font-size: 22px; color: #38bdf8; }
.subtitle { text-align: center; color: #64748b; margin-bottom: 20px; font-size: 13px; }

.toolbar {
  display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;
}
.toolbar button {
  padding: 8px 18px; border: 1px solid #334155; border-radius: 6px;
  background: #1e293b; color: #e2e8f0; cursor: pointer; font-size: 13px;
  transition: all .2s;
}
.toolbar button:hover { background: #334155; border-color: #38bdf8; }
.toolbar button.running { background: #0c4a6e; border-color: #38bdf8; cursor: wait; }
.toolbar button.primary { background: #0369a1; border-color: #0ea5e9; }

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

.card {
  background: #1e293b; border: 1px solid #334155; border-radius: 10px;
  padding: 16px; position: relative; transition: border-color .3s;
}
.card.pass { border-color: #22c55e; }
.card.fail { border-color: #ef4444; }
.card.running { border-color: #eab308; }
.card.skip { border-color: #64748b; opacity: .6; }

.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.card-id { font-weight: 700; color: #38bdf8; font-size: 14px; }
.card-status {
  font-size: 11px; padding: 2px 10px; border-radius: 20px; font-weight: 600;
}
.card-status.pending { background: #334155; color: #94a3b8; }
.card-status.running { background: #854d0e; color: #fde047; }
.card-status.pass { background: #14532d; color: #4ade80; }
.card-status.fail { background: #7f1d1d; color: #fca5a5; }
.card-status.skip { background: #334155; color: #64748b; }

.card-purpose { font-size: 12px; color: #94a3b8; margin-bottom: 10px; }
.card-input { font-size: 12px; color: #cbd5e1; background: #0f172a; padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; }

.events-box {
  max-height: 200px; overflow-y: auto; font-size: 11px; font-family: 'SF Mono', monospace;
  background: #0f172a; border-radius: 4px; padding: 8px; line-height: 1.6;
}
.events-box .ev-process { color: #38bdf8; }
.events-box .ev-thinking { color: #a78bfa; }
.events-box .ev-answer { color: #4ade80; }
.events-box .ev-finish { color: #64748b; }
.events-box .ev-error { color: #ef4444; }

.assertions { margin-top: 8px; font-size: 11px; }
.assertions div { padding: 2px 0; }
.assertions .ok { color: #4ade80; }
.assertions .fail { color: #fca5a5; }

.summary-bar {
  margin-top: 20px; text-align: center; padding: 12px;
  background: #1e293b; border-radius: 8px; font-size: 14px;
}
</style>
</head>
<body>
<h1>ITS å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ â€” å…¨é“¾è·¯æµ‹è¯•</h1>
<p class="subtitle">POST /api/query Â· SSE æµå¼ Â· http://127.0.0.1:8000</p>

<div class="toolbar">
  <button class="primary" onclick="runAll()">â–¶ è¿è¡Œå…¨éƒ¨</button>
  <button onclick="runOne('TC-01')">TC-01 é—²èŠ</button>
  <button onclick="runOne('TC-02')">TC-02 è¿½é—®</button>
  <button onclick="runOne('TC-03')">TC-03 KBå‘½ä¸­</button>
  <button onclick="runOne('TC-04')">TC-04 æ¢æºWeb</button>
  <button onclick="runOne('TC-05')">TC-05 å‡çº§äººå·¥</button>
  <button onclick="runOne('TC-06')">TC-06 æœåŠ¡ç«™</button>
  <button onclick="runOne('TC-07')">TC-07 å¯¼èˆª</button>
  <button onclick="runOne('TC-09')">TC-09 æµå¼è¿‡æ»¤</button>
</div>

<div class="grid" id="grid"></div>
<div class="summary-bar" id="summary">å°±ç»ª â€” ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•</div>

<script>
const API = 'http://127.0.0.1:8000/api/query';
</script>
<script>
// â”€â”€ Test Case Definitions â”€â”€
const TEST_CASES = [
  {
    id: 'TC-01', name: 'é—²èŠåœºæ™¯',
    purpose: 'éªŒè¯æ„å›¾è¯†åˆ«è·¯ç”±åˆ° general_chatï¼Œä¸è§¦å‘æ£€ç´¢',
    input: 'ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”çœŸä¸é”™',
    assertions: [
      { name: 'å‡ºç° general_chat èŠ‚ç‚¹', fn: ctx => ctx.processes.some(p => p.includes('general_chat')) },
      { name: 'æ—  slot_filling èŠ‚ç‚¹', fn: ctx => !ctx.processes.some(p => p.includes('slot_filling')) },
      { name: 'æ—  retrieval èŠ‚ç‚¹', fn: ctx => !ctx.processes.some(p => p.includes('retrieval')) },
      { name: 'æœ‰å‹å¥½å›å¤', fn: ctx => ctx.answer.length > 5 },
    ]
  },
  {
    id: 'TC-02', name: 'æ§½ä½ä¸å®Œæ•´è¿½é—®',
    purpose: 'éªŒè¯æ§½ä½ç¼ºå¤±æ—¶èµ° ask_user åˆ†æ”¯',
    input: 'ç”µè„‘è“å±äº†',
    assertions: [
      { name: 'å‡ºç° ask_user èŠ‚ç‚¹', fn: ctx => ctx.processes.some(p => p.includes('ask_user')) },
      { name: 'æ—  retrieval èŠ‚ç‚¹', fn: ctx => !ctx.processes.some(p => p.includes('retrieval')) },
      { name: 'è¿”å›è¿½é—®è¯æœ¯', fn: ctx => ctx.answer.length > 5 },
      { name: 'is_ask_user=true', fn: ctx => ctx.hasAskUser },
    ]
  },
  {
    id: 'TC-03', name: 'KBå‘½ä¸­å…¨é“¾è·¯',
    purpose: 'éªŒè¯æŠ€æœ¯é—®é¢˜å®Œæ•´èµ°å®Œæ£€ç´¢ï¼ŒçŸ¥è¯†åº“è¿”å›ç­”æ¡ˆ',
    input: 'æˆ‘çš„ ThinkPad X1 Carbon å‡çº§ç³»ç»Ÿåè“å±ï¼Œé”™è¯¯ä»£ç  0x0000007E',
    skip: true, skipReason: 'éœ€è¦çŸ¥è¯†åº“æœåŠ¡',
    assertions: []
  },
  {
    id: 'TC-04', name: 'KBæœªå‘½ä¸­æ¢æºWeb',
    purpose: 'éªŒè¯ KB æ— ç»“æœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ° Web æœç´¢',
    input: 'è”æƒ³ Legion 7i 2025æ¬¾ æ•£çƒ­é£æ‰‡å¼‚å“æ€ä¹ˆå¤„ç†',
    skip: true, skipReason: 'éœ€è¦çŸ¥è¯†åº“æœåŠ¡',
    assertions: []
  },
  {
    id: 'TC-05', name: 'æ£€ç´¢ä¸åˆæ ¼å‡çº§äººå·¥',
    purpose: 'éªŒè¯ verify èŠ‚ç‚¹è´¨é‡æŠŠå…³ï¼Œä¸ç›¸å…³æ—¶èµ° escalate',
    input: 'xyzabc123 å‹å·ä¸»æ¿çƒ§äº†æ€ä¹ˆä¿®',
    assertions: [
      { name: 'å‡ºç° escalate èŠ‚ç‚¹', fn: ctx => ctx.processes.some(p => p.includes('escalate')) },
      { name: 'åŒ…å«äººå·¥å®¢æœè¯æœ¯', fn: ctx => /äººå·¥|å®¢æœ|è½¬æ¥|å·¥ç¨‹å¸ˆ/.test(ctx.answer) },
      { name: 'æ—  generate_report', fn: ctx => !ctx.processes.some(p => p.includes('generate_report')) },
    ]
  },
  {
    id: 'TC-06', name: 'æœåŠ¡ç«™æŸ¥è¯¢',
    purpose: 'éªŒè¯æœåŠ¡ç«™æ„å›¾èµ° MySQL + åæ ‡è§£æ',
    input: 'åŒ—äº¬æœé˜³åŒºé™„è¿‘æœ‰è”æƒ³æœåŠ¡ç«™å—',
    assertions: [
      { name: 'å‡ºç° retrieval èŠ‚ç‚¹', fn: ctx => ctx.processes.some(p => p.includes('retrieval')) },
      { name: 'åŒ…å«æœåŠ¡ç«™ä¿¡æ¯', fn: ctx => /æœåŠ¡ç«™|åœ°å€|ç”µè¯|è”æƒ³/.test(ctx.answer) },
      { name: 'æœ‰å›å¤å†…å®¹', fn: ctx => ctx.answer.length > 10 },
    ]
  },
  {
    id: 'TC-07', name: 'POIå¯¼èˆªæŸ¥è¯¢',
    purpose: 'éªŒè¯å¯¼èˆªæ„å›¾è°ƒç”¨ç™¾åº¦åœ°å›¾ MCP',
    input: 'å¸®æˆ‘å¯¼èˆªåˆ°è”æƒ³åŒ—äº¬æ€»éƒ¨',
    assertions: [
      { name: 'è°ƒç”¨åœ°å›¾å·¥å…·', fn: ctx => ctx.processes.some(p => /map|åœ°å›¾|poi|å¯¼èˆª/.test(p)) },
      { name: 'åŒ…å«åœ°ç‚¹ä¿¡æ¯', fn: ctx => /åœ°å€|ä½ç½®|è”æƒ³|åŒ—äº¬/.test(ctx.answer) },
      { name: 'æœ‰å›å¤å†…å®¹', fn: ctx => ctx.answer.length > 10 },
    ]
  },
  {
    id: 'TC-09', name: 'æµå¼è¾“å‡ºè¿‡æ»¤',
    purpose: 'éªŒè¯ ANSWER ä»…æ¥è‡ªç­”æ¡ˆèŠ‚ç‚¹ï¼Œä¸­é—´èŠ‚ç‚¹ä¸æ³„æ¼',
    input: 'ThinkPad X1 è“å±ï¼Œé”™è¯¯ä»£ç  0x00000050',
    skip: true, skipReason: 'éœ€è¦çŸ¥è¯†åº“æœåŠ¡',
    assertions: []
  },
];
</script>
<script>
// â”€â”€ State â”€â”€
let results = {};
let sessionCounter = 0;

// â”€â”€ Render â”€â”€
function render() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  for (const tc of TEST_CASES) {
    const r = results[tc.id] || { status: tc.skip ? 'skip' : 'pending', events: [], assertResults: [] };
    const card = document.createElement('div');
    card.className = `card ${r.status}`;
    card.innerHTML = buildCardHTML(tc, r);
    grid.appendChild(card);
  }
  updateSummary();
}

function buildCardHTML(tc, r) {
  let html = `
    <div class="card-header">
      <span class="card-id">${tc.id} ${tc.name}</span>
      <span class="card-status ${r.status}">${statusLabel(r.status, tc)}</span>
    </div>
    <div class="card-purpose">${tc.purpose}</div>
    <div class="card-input">ğŸ“ ${tc.input}</div>
  `;
  if (r.events.length > 0) {
    html += `<div class="events-box">`;
    for (const ev of r.events) {
      html += `<div class="ev-${ev.kind}">${escapeHtml(ev.text)}</div>`;
    }
    html += `</div>`;
  }
  if (r.assertResults.length > 0) {
    html += `<div class="assertions">`;
    for (const a of r.assertResults) {
      html += `<div class="${a.ok ? 'ok' : 'fail'}">${a.ok ? 'âœ…' : 'âŒ'} ${a.name}</div>`;
    }
    html += `</div>`;
  }
  return html;
}

function statusLabel(s, tc) {
  if (s === 'skip') return `â­ è·³è¿‡: ${tc.skipReason || ''}`;
  return { pending: 'â³ å¾…è¿è¡Œ', running: 'ğŸ”„ è¿è¡Œä¸­', pass: 'âœ… é€šè¿‡', fail: 'âŒ å¤±è´¥' }[s] || s;
}

function escapeHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function updateSummary() {
  const total = TEST_CASES.filter(t => !t.skip).length;
  const passed = Object.values(results).filter(r => r.status === 'pass').length;
  const failed = Object.values(results).filter(r => r.status === 'fail').length;
  const running = Object.values(results).filter(r => r.status === 'running').length;
  const bar = document.getElementById('summary');
  if (running > 0) {
    bar.textContent = `è¿è¡Œä¸­... ${passed} é€šè¿‡ / ${failed} å¤±è´¥ / ${running} è¿›è¡Œä¸­ / ${total} æ€»è®¡`;
    bar.style.color = '#eab308';
  } else if (failed > 0) {
    bar.textContent = `å®Œæˆ â€” ${passed} é€šè¿‡ / ${failed} å¤±è´¥ / ${total} æ€»è®¡`;
    bar.style.color = '#ef4444';
  } else if (passed === total) {
    bar.textContent = `å…¨éƒ¨é€šè¿‡ âœ… ${passed}/${total}`;
    bar.style.color = '#4ade80';
  } else {
    bar.textContent = `å°±ç»ª â€” ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•`;
    bar.style.color = '#94a3b8';
  }
}
</script>
<script>
// â”€â”€ SSE Runner â”€â”€
async function runTestCase(tc) {
  if (tc.skip) return;

  const sid = `test_session_${Date.now()}_${++sessionCounter}`;
  results[tc.id] = { status: 'running', events: [], assertResults: [] };
  render();

  const ctx = { processes: [], answer: '', hasAskUser: false, answerNodes: [], allPackets: [] };

  try {
    const resp = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: tc.input,
        context: { user_id: 'test_user', session_id: sid }
      })
    });

    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });

      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (!line.startsWith('data:')) continue;
        const jsonStr = line.slice(5).trim();
        if (!jsonStr) continue;

        try {
          const packet = JSON.parse(jsonStr);
          ctx.allPackets.push(packet);
          processPacket(tc.id, packet, ctx);
        } catch (e) { /* skip malformed */ }
      }
    }

    // Process remaining buffer
    if (buffer.startsWith('data:')) {
      try {
        const packet = JSON.parse(buffer.slice(5).trim());
        ctx.allPackets.push(packet);
        processPacket(tc.id, packet, ctx);
      } catch (e) { /* skip */ }
    }

    // Run assertions
    runAssertions(tc, ctx);

  } catch (err) {
    results[tc.id].events.push({ kind: 'error', text: `é”™è¯¯: ${err.message}` });
    results[tc.id].status = 'fail';
  }

  render();
}

function processPacket(tcId, packet, ctx) {
  const r = results[tcId];
  const content = packet.content || {};
  const kind = (content.kind || '').toLowerCase();
  const text = content.text || '';
  const contentType = content.contentType || '';

  if (contentType === 'sagegpt/finish') {
    r.events.push({ kind: 'finish', text: 'â”€â”€ æµç»“æŸ â”€â”€' });
    return;
  }

  if (kind === 'process') {
    ctx.processes.push(text);
    r.events.push({ kind: 'process', text });
  } else if (kind === 'thinking') {
    const short = text.length > 80 ? text.slice(0, 80) + '...' : text;
    r.events.push({ kind: 'thinking', text: `ğŸ’­ ${short}` });
  } else if (kind === 'answer') {
    ctx.answer += text;
    r.events.push({ kind: 'answer', text: `ğŸ’¬ ${text.slice(0, 120)}${text.length > 120 ? '...' : ''}` });
  }

  if (packet.is_ask_user) ctx.hasAskUser = true;
}

function runAssertions(tc, ctx) {
  const r = results[tc.id];
  let allPass = true;
  for (const a of tc.assertions) {
    let ok = false;
    try { ok = a.fn(ctx); } catch (e) { ok = false; }
    r.assertResults.push({ name: a.name, ok });
    if (!ok) allPass = false;
  }
  r.status = tc.assertions.length === 0 ? 'pass' : (allPass ? 'pass' : 'fail');
}
</script>
<script>
// â”€â”€ Controls â”€â”€
async function runOne(id) {
  const tc = TEST_CASES.find(t => t.id === id);
  if (tc) await runTestCase(tc);
}

async function runAll() {
  for (const tc of TEST_CASES) {
    if (!tc.skip) await runTestCase(tc);
  }
}

// â”€â”€ Init â”€â”€
render();
</script>
</body>
</html>
