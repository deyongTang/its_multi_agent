#!/bin/bash
# GitHub Actions è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
# ç”¨é€”ï¼šåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè‡ªåŠ¨æ‹‰å–ä»£ç ã€æ„å»ºé•œåƒã€å¯åŠ¨æœåŠ¡

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "=========================================="
echo "ğŸš€ ITS Knowledge çŸ¥è¯†åº“å¹³å° - è‡ªåŠ¨éƒ¨ç½²"
echo "=========================================="

# ============================================
# 0. åˆå§‹åŒ–ï¼šç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•
# ============================================
PROJECT_DIR="/opt/its_multi_agent"

echo ""
echo "ğŸ“ åˆå§‹åŒ–: å½“å‰ç›®å½• $(pwd)"
echo "ğŸ“ ç›®æ ‡ç›®å½•: $PROJECT_DIR"

# å¦‚æœé¡¹ç›®ç›®å½•å­˜åœ¨ï¼Œå…ˆåˆ‡æ¢åˆ°è¯¥ç›®å½•
if [ -d "$PROJECT_DIR" ]; then
    cd "$PROJECT_DIR"
    echo "âœ… å·²åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•"
else
    echo "âš ï¸  é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åœ¨æ­¥éª¤2ä¸­åˆ›å»º"
fi

# ============================================
# 1. ç¯å¢ƒæ£€æŸ¥
# ============================================
echo ""
echo "ğŸ“‹ æ­¥éª¤ 1/7: æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ..."

# æ£€æŸ¥ Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ é”™è¯¯: Docker æœªå®‰è£…"
    exit 1
fi

# æ£€æŸ¥ docker-compose
if ! command -v docker-compose &> /dev/null; then
    echo "âŒ é”™è¯¯: docker-compose æœªå®‰è£…"
    exit 1
fi

echo "âœ… Docker ç¯å¢ƒæ£€æŸ¥é€šè¿‡"

# ============================================
# 2. å‡†å¤‡é¡¹ç›®ç›®å½•
# ============================================
echo ""
echo "ğŸ“‚ æ­¥éª¤ 2/7: å‡†å¤‡é¡¹ç›®ç›®å½•..."

# æ£€æŸ¥æ˜¯å¦åœ¨ Git ä»“åº“ä¸­
if [ -d "$PROJECT_DIR/.git" ]; then
    echo "âœ… Git ä»“åº“å·²å­˜åœ¨"
elif [ -d "$PROJECT_DIR" ]; then
    # ç›®å½•å­˜åœ¨ä½†ä¸æ˜¯ Git ä»“åº“
    echo "âš ï¸  è­¦å‘Š: ç›®å½•å­˜åœ¨ä½†ä¸æ˜¯ Git ä»“åº“ï¼Œåˆ é™¤å¹¶é‡æ–°å…‹éš†..."
    cd /opt
    rm -rf its_multi_agent
    git clone https://github.com/deyongTang/its_multi_agent.git
    cd its_multi_agent
else
    # ç›®å½•ä¸å­˜åœ¨
    echo "ğŸ“¥ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œå¼€å§‹å…‹éš†ä»“åº“..."
    cd /opt
    git clone https://github.com/deyongTang/its_multi_agent.git
    cd its_multi_agent
fi

echo "âœ… å½“å‰ç›®å½•: $(pwd)"

# ============================================
# 3. æ‹‰å–æœ€æ–°ä»£ç 
# ============================================
echo ""
echo "ğŸ“¥ æ­¥éª¤ 3/7: æ‹‰å–æœ€æ–°ä»£ç ..."

# é…ç½® Gitï¼ˆé¿å…è®¤è¯é—®é¢˜ï¼‰
git config pull.rebase false

# æ‹‰å–æœ€æ–°ä»£ç 
git fetch origin main
git reset --hard origin/main

echo "âœ… ä»£ç æ›´æ–°å®Œæˆ"

# ============================================
# 4. è¿›å…¥çŸ¥è¯†åº“ç›®å½•
# ============================================
echo ""
echo "ğŸ“‚ æ­¥éª¤ 4/7: è¿›å…¥çŸ¥è¯†åº“ç›®å½•..."

cd backend/knowledge

if [ ! -f docker-compose.yml ]; then
    echo "âŒ é”™è¯¯: docker-compose.yml æ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

echo "âœ… å½“å‰ç›®å½•: $(pwd)"

# ============================================
# 5. åœæ­¢æ—§å®¹å™¨
# ============================================
echo ""
echo "ğŸ›‘ æ­¥éª¤ 5/7: åœæ­¢æ—§å®¹å™¨..."

docker-compose down || true
echo "âœ… æ—§å®¹å™¨å·²åœæ­¢"

# ============================================
# 6. æ„å»ºæ–°é•œåƒ
# ============================================
echo ""
echo "ğŸ”¨ æ­¥éª¤ 6/7: æ„å»º Docker é•œåƒ..."

docker-compose build --no-cache
echo "âœ… é•œåƒæ„å»ºå®Œæˆ"

# ============================================
# 7. å¯åŠ¨æ–°å®¹å™¨
# ============================================
echo ""
echo "ğŸš€ æ­¥éª¤ 7/7: å¯åŠ¨æ–°å®¹å™¨..."

docker-compose up -d
echo "âœ… å®¹å™¨å¯åŠ¨å®Œæˆ"

# ============================================
# 8. éªŒè¯éƒ¨ç½²
# ============================================
echo ""
echo "ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€..."
echo ""

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 5

# æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
docker-compose ps

echo ""
echo "ğŸ“ å®¹å™¨æ—¥å¿—ï¼ˆæœ€å 20 è¡Œï¼‰:"
docker-compose logs --tail=20

echo ""
echo "=========================================="
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "=========================================="
echo ""
echo "ğŸ“ API æ–‡æ¡£: http://æœåŠ¡å™¨IP:8001/docs"
echo "ï¿½ï¿½ æŸ¥çœ‹æ—¥å¿—: docker-compose logs -f"
echo "ğŸ” æ£€æŸ¥çŠ¶æ€: docker-compose ps"
echo ""
