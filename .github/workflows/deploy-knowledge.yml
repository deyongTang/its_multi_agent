name: Deploy Knowledge Platform

on:
  workflow_dispatch:  # 手动触发
  push:
    branches:
      - main
    paths:
      - 'backend/knowledge/**'  # 只有知识库代码变更时才触发

jobs:
  deploy:
    name: 部署到远程服务器
    runs-on: ubuntu-latest

    steps:
      - name: 执行远程部署
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e

            # 检查项目目录是否存在
            if [ ! -d /opt/its_multi_agent ]; then
              echo "项目目录不存在，首次部署需要先克隆仓库"
              cd /opt
              git clone https://${{ secrets.GH_TOKEN }}@github.com/deyongTang/its_multi_agent.git
            fi

            # 进入项目目录并拉取最新代码
            cd /opt/its_multi_agent
            echo "拉取最新代码..."

            # 配置 Git 使用 token
            git config pull.rebase false
            git remote set-url origin https://${{ secrets.GH_TOKEN }}@github.com/deyongTang/its_multi_agent.git

            # 拉取最新代码
            git fetch origin main
            git reset --hard origin/main

            # 执行项目中的部署脚本
            bash backend/knowledge/deploy-auto.sh
